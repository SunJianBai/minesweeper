## MASM Minesweeper（Win32 图形版扫雷）

本项目是一个基于 MASM 的 Win32 图形版扫雷游戏，实现完整的扫雷玩法、声音效果和贴图渲染，同时仍然支持控制台调试输出。

---

## 功能特性

- **完整扫雷规则**

  - 支持左键点开格子、右键插旗/取消旗。
  - 自动展开空白区域（递归 flood-fill）。
  - 胜利/失败判定与提示框。
- **多难度支持**

  - 窗口菜单中提供 Easy / Medium / Expert 三种难度。
  - 不同难度会改变棋盘尺寸与地雷数量。
- **HUD 信息显示**

  - 左上角 Reset 按钮：点击后重新开始当前难度的游戏。
  - 右上角实时显示：
    - 剩余地雷数（`Mines left`）。
    - 计时器（秒），在第一次有效点击后开始计时。
- **声音效果（嵌入资源）**

  - 点击格子时播放 `click.mp3`。
  - 踩到地雷时播放 `boom.mp3`。
  - 两个 mp3 文件以资源形式嵌入 exe，运行时释放到临时目录，通过 MCI 播放。
- **贴图渲染**

  - 使用旧工程中的 `MINE_COLOR.BMP` 作为格子贴图素材。
  - 一个位图中竖直排布了 16 个小格子，分别代表：未点击、旗子、数字 1–8、空白、不同状态下的雷等。
  - 程序根据每个格子的状态（是否是雷、是否被打开、是否插旗、周围雷数、游戏胜负状态）选取对应的贴图并使用 `StretchBlt` 绘制到窗口上。
- **窗口图标**

  - 运行时从 `res\favicon.ico` 加载应用程序图标，设置为窗口大图标与小图标。
- **控制台调试模式（可选）**

  - 默认运行时不会出现控制台窗口（适合普通用户双击使用）。
  - 带特定参数启动时可以保留控制台，并输出调试日志（如布雷信息、点击坐标等）。

---

## 目录结构（简要）

仓库根目录下与扫雷相关的主要文件：

- `minesweepe.asm`：主汇编源文件，包含：
  - 游戏逻辑：布雷、展开空白、插旗、胜负判定等。
  - Win32 GUI：窗口创建、消息循环、绘制棋盘和 HUD。
  - 声音资源处理：从资源释放 mp3 到临时文件并通过 MCI 播放。
  - 贴图渲染：加载 `MINE_COLOR.BMP` 并按格子状态绘制。
  - 命令行解析：根据是否带 `console` 参数决定是否保留控制台。
- `minesweepe.rc`：资源脚本文件，定义了：
  - 嵌入的 `click.mp3` 与 `boom.mp3`（RCDATA 资源）。
  - 棋盘贴图 `MINE_COLOR.BMP`（BITMAP 资源）。
- `resource.h`：资源 ID 定义（mp3 与位图等）。
- `res/` 目录：
  - `MINE_COLOR.BMP`：格子贴图位图。
  - `click.mp3` / `boom.mp3`：声音资源源文件。
  - `favicon.ico`：应用图标，程序运行时从此文件加载。
- `build.bat`：构建脚本，用于清理并重新编译/链接工程。
- `run.bat`：以带控制台参数的方式运行 exe，便于调试。

---

## 环境与依赖

- **操作系统**：Windows（推荐 Windows 10 或更高版本）。
- **工具链**：
  - MASM（`ml`），示例中使用的是 6.14 版本。
  - Microsoft `link`、`rc`（资源编译器）。
  - 建议在 **Visual Studio Developer Command Prompt** 或已经配置好 VS 工具链的命令行环境中运行 `build.bat`，以保证 `ml` / `link` / `rc` 在 PATH 中可用。

---

## 编译步骤

在项目根目录（包含 `minesweepe.asm` 的目录）下：

1. 打开 **VS Developer Command Prompt**（或任何已设置好 VS 工具链的命令行）。
2. 切换到工程目录，例如：
   ```bat
   cd /d D:\学习\人在BIT\大三上\汇编语言与接口技术\lab\Assembly Experiment
   ```
3. 运行构建脚本：
   ```bat
   build.bat
   ```

脚本会自动执行以下步骤：

- 删除旧的中间文件与输出文件：
  - `minesweepe.obj` / `minesweepe.exe` / `minesweepe.res` / `minesweepe.pdb` / `minesweepe.ilk`。
- 调用 `rc /r minesweepe.rc` 编译资源文件。
- 调用 `ml /c /coff /Zi minesweepe.asm` 汇编生成 obj 文件。
- 调用 `link /SUBSYSTEM:CONSOLE /DEBUG ...` 链接生成 `minesweepe.exe`。

如中间任何一步失败，脚本会提示 `Build failed, please check messages above.`，并暂停等待查看错误信息。

> 注：虽然链接时使用的是 `/SUBSYSTEM:CONSOLE`，但程序在入口处会根据命令行参数主动释放/保留控制台，因此行为仍符合「默认无控制台，调试时有控制台」的要求。

---

## 运行说明

### 1. 普通运行（无控制台）

编译成功后，直接**双击 `minesweepe.exe`**，或在命令行中执行：

```bat
minesweepe.exe
```

此时程序会在入口处调用 `FreeConsole` 释放控制台窗口，只保留图形窗口，不显示 printf 调试输出，适合作为普通应用使用。

### 2. 调试运行（带控制台）

如果需要观察调试输出（布雷信息、点击坐标、游戏过程日志等），可以带上 `console` 参数运行，或使用已经准备好的脚本：

- 方式一：命令行直接运行：

  ```bat
  minesweepe.exe console
  ```
- 方式二：使用 `run.bat`：

  ```bat
  run.bat
  ```

`run.bat` 会自动切换到脚本所在目录，并以 `minesweepe.exe console` 方式启动，使控制台窗口保持打开。

程序内部逻辑：

- 在 `main` 函数中使用 `GetCommandLine` 获取完整命令行字符串。
- 搜索其中是否包含子串 `" console"`：
  - 找到则认为需要调试模式：
    - **保留控制台**。
    - 执行 `printf` 输出调试日志。
  - 未找到则认为是普通运行：
    - 调用 `FreeConsole` 主动释放控制台窗口。

---

## 游戏操作

- **鼠标左键**：

  - 点击未打开且未插旗的格子：
    - 若该格子为雷：触发爆炸，播放 `boom.mp3`，显示失败状态。
    - 若该格子不是雷：
      - 若周围有雷数 > 0：只打开当前格子并显示数字。
      - 若周围无雷：自动展开周围大片空白区域。
- **鼠标右键**：

  - 在未打开的格子上切换旗子状态：
    - 原本无旗 -> 插旗，剩余地雷数减 1。
    - 原本有旗 -> 取消旗子，剩余地雷数加 1。
- **Reset 按钮**（左上角）

  - 任意时刻点击会重新初始化当前难度的棋盘、重新布雷并重置计时器。
- **菜单栏难度切换**：

  - Easy / Medium / Expert：
    - 切换后会重新初始化棋盘尺寸和地雷数量。
    - 窗口大小会根据棋盘大小自动调整，并将棋盘居中显示。
- **胜负提示**：

  - 失败：点到雷时，所有雷会显示出来，被点中的雷使用特殊贴图，弹出失败提示框。
  - 胜利：当所有非雷格子都被打开时，游戏判定胜利，所有雷会以“胜利贴图”显示，并弹出带用时信息的提示框。

---

## 实现要点概览

### 棋盘数据结构

- 使用一维数组 `board_grid` 存储棋盘，每个格子占 4 字节：
  - 第 1 字节：是否有地雷（1 = 雷，0 = 无雷）。
  - 第 2 字节：是否已打开（1 = 已打开，0 = 未打开）。
  - 第 3 字节：是否有旗子（1 = 有旗，0 = 无旗）。
  - 第 4 字节：周围 8 个格子的雷数（0–8）。

### 贴图渲染

- 在 `WM_CREATE` 中加载位图资源 `MINE_COLOR.BMP` 到内存 DC。
- 在 `DrawGameBoard` 中：
  - 遍历全部格子，根据当前 `game_state`、格子状态（雷/非雷、是否打开、是否有旗子、周围雷数）、以及最后一次点击的雷位置，计算需要使用的贴图索引。
  - 从位图中对应的 16×16 小格子区域使用 `StretchBlt` 绘制到窗口格子区域。

### 声音播放

- 将 `click.mp3` 与 `boom.mp3` 以 RCDATA 形式嵌入资源。
- 程序启动时：
  - 使用 `FindResource` / `LoadResource` / `LockResource` / `SizeofResource` 读出资源数据。
  - 写入到临时目录下的临时文件。
  - 使用 `mciSendStringA` 打开并建立别名 `clicksnd` / `boomsnd`。
- 点击事件中：
  - 仅在格子状态实际发生变化时播放点击音。
  - 仅在本次点击确实踩到雷时播放爆炸音。

### 控制台控制

- 默认链接为 CONSOLE 子系统，保证 `printf` 等调试输出可用。
- 通过命令行解析 + `FreeConsole` 实现“默认无控制台，按需保留”的行为。
